<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>OS | Josherich logs</title>
    <meta name="description" content="Josherich logs">
    <link rel="icon" href="/logs/logo.png">
  <link rel="manifest" href="/logs/manifest.json">
  <meta name="theme-color" content="#fff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="/logs/apple-touch-icon.png">
  <link rel="mask-icon" href="/logs/safari-pinned-tab.svg" color="#ff8549">
    
    <link rel="preload" href="/logs/assets/css/0.styles.7191ec3a.css" as="style"><link rel="preload" href="/logs/assets/js/app.09a71387.js" as="script"><link rel="preload" href="/logs/assets/js/2.5fba0fc3.js" as="script"><link rel="preload" href="/logs/assets/js/24.a688e03c.js" as="script"><link rel="prefetch" href="/logs/assets/js/10.d006e7a8.js"><link rel="prefetch" href="/logs/assets/js/11.fd749eab.js"><link rel="prefetch" href="/logs/assets/js/12.e197d713.js"><link rel="prefetch" href="/logs/assets/js/13.5faee3eb.js"><link rel="prefetch" href="/logs/assets/js/14.dd1edca1.js"><link rel="prefetch" href="/logs/assets/js/15.8ccfa7a9.js"><link rel="prefetch" href="/logs/assets/js/16.0254efc1.js"><link rel="prefetch" href="/logs/assets/js/17.e177a4da.js"><link rel="prefetch" href="/logs/assets/js/18.1cf5c84a.js"><link rel="prefetch" href="/logs/assets/js/19.0a4d2d26.js"><link rel="prefetch" href="/logs/assets/js/20.6ad277bf.js"><link rel="prefetch" href="/logs/assets/js/21.f653a922.js"><link rel="prefetch" href="/logs/assets/js/22.d66a1538.js"><link rel="prefetch" href="/logs/assets/js/23.c2b61054.js"><link rel="prefetch" href="/logs/assets/js/25.ce0b2b01.js"><link rel="prefetch" href="/logs/assets/js/26.98393859.js"><link rel="prefetch" href="/logs/assets/js/27.9c56208f.js"><link rel="prefetch" href="/logs/assets/js/28.2b361e5f.js"><link rel="prefetch" href="/logs/assets/js/3.e79b47f3.js"><link rel="prefetch" href="/logs/assets/js/4.824b2f94.js"><link rel="prefetch" href="/logs/assets/js/5.cf7ef866.js"><link rel="prefetch" href="/logs/assets/js/6.d8e82984.js"><link rel="prefetch" href="/logs/assets/js/7.99d61cc4.js"><link rel="prefetch" href="/logs/assets/js/8.1099fc02.js"><link rel="prefetch" href="/logs/assets/js/9.64f7f7fe.js">
    <link rel="stylesheet" href="/logs/assets/css/0.styles.7191ec3a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/logs/" class="home-link router-link-active"><!----> <span class="site-name">Josherich logs</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/logs/" class="nav-link">Home</a></div> <a href="https://github.com/josherich/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/logs/" class="nav-link">Home</a></div> <a href="https://github.com/josherich/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Home</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Logs</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/logs/logs.html" class="sidebar-link">Logs</a></li><li><a href="/logs/cloud.html" class="sidebar-link">cloud</a></li><li><a href="/logs/cpp.html" class="sidebar-link">CPP</a></li><li><a href="/logs/cs.html" class="sidebar-link">CS</a></li><li><a href="/logs/database.html" class="sidebar-link">Database</a></li><li><a href="/logs/draw.html" class="sidebar-link">Draw</a></li><li><a href="/logs/frontend.html" class="sidebar-link">Front end</a></li><li><a href="/logs/gaming.html" class="sidebar-link">Books</a></li><li><a href="/logs/josherich.html" class="sidebar-link">Josherich</a></li><li><a href="/logs/languages.html" class="sidebar-link">Language</a></li><li><a href="/logs/math.html" class="sidebar-link">Math</a></li><li><a href="/logs/ml.html" class="sidebar-link">Machine Learning</a></li><li><a href="/logs/nlp.html" class="sidebar-link">NLP</a></li><li><a href="/logs/numpy.html" class="sidebar-link">Numpy</a></li><li><a href="/logs/ops.html" class="sidebar-link">Ops</a></li><li><a href="/logs/os.html" class="active sidebar-link">OS</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/logs/os.html#concept" class="sidebar-link">concept</a></li><li class="sidebar-sub-header"><a href="/logs/os.html#ring-level" class="sidebar-link">Ring level</a></li><li class="sidebar-sub-header"><a href="/logs/os.html#register" class="sidebar-link">Register</a></li><li class="sidebar-sub-header"><a href="/logs/os.html#assembly" class="sidebar-link">assembly</a></li><li class="sidebar-sub-header"><a href="/logs/os.html#interrupt-vector" class="sidebar-link">Interrupt vector</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/logs/os.html#program-status-word" class="sidebar-link">program status word</a></li></ul></li><li class="sidebar-sub-header"><a href="/logs/os.html#address-space" class="sidebar-link">address space</a></li><li class="sidebar-sub-header"><a href="/logs/os.html#process-control-block" class="sidebar-link">process control block</a></li><li class="sidebar-sub-header"><a href="/logs/os.html#process-struct" class="sidebar-link">process struct</a></li><li class="sidebar-sub-header"><a href="/logs/os.html#process-scheduling" class="sidebar-link">process scheduling</a></li><li class="sidebar-sub-header"><a href="/logs/os.html#context-switch" class="sidebar-link">context switch</a></li><li class="sidebar-sub-header"><a href="/logs/os.html#process-creation" class="sidebar-link">process creation</a></li><li class="sidebar-sub-header"><a href="/logs/os.html#process-termination" class="sidebar-link">process termination</a></li><li class="sidebar-sub-header"><a href="/logs/os.html#param-passing" class="sidebar-link">param passing</a></li><li class="sidebar-sub-header"><a href="/logs/os.html#system-call" class="sidebar-link">system call</a></li><li class="sidebar-sub-header"><a href="/logs/os.html#system-call-list" class="sidebar-link">system call list</a></li><li class="sidebar-sub-header"><a href="/logs/os.html#system-programs" class="sidebar-link">system programs</a></li><li class="sidebar-sub-header"><a href="/logs/os.html#process-states" class="sidebar-link">process states</a></li><li class="sidebar-sub-header"><a href="/logs/os.html#short-term-scheduler" class="sidebar-link">short-term scheduler</a></li><li class="sidebar-sub-header"><a href="/logs/os.html#dispatcher" class="sidebar-link">dispatcher</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/logs/os.html#conflict-phase" class="sidebar-link">conflict phase</a></li></ul></li><li class="sidebar-sub-header"><a href="/logs/os.html#scheduler-metric" class="sidebar-link">scheduler metric</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/logs/os.html#convoy-effect" class="sidebar-link">convoy effect</a></li></ul></li><li class="sidebar-sub-header"><a href="/logs/os.html#priority-scheduling" class="sidebar-link">priority scheduling</a></li><li class="sidebar-sub-header"><a href="/logs/os.html#round-robin-with-quantum" class="sidebar-link">round robin with quantum</a></li><li class="sidebar-sub-header"><a href="/logs/os.html#multilevel-queue" class="sidebar-link">multilevel queue</a></li><li class="sidebar-sub-header"><a href="/logs/os.html#thread-scheduling" class="sidebar-link">thread scheduling</a></li><li class="sidebar-sub-header"><a href="/logs/os.html#multi-processor-scheudling" class="sidebar-link">multi processor scheudling</a></li><li class="sidebar-sub-header"><a href="/logs/os.html#real-time-scheduling" class="sidebar-link">real time scheduling</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/logs/os.html#rate-montonic-scheduling" class="sidebar-link">Rate Montonic Scheduling</a></li><li class="sidebar-sub-header"><a href="/logs/os.html#earliest-deadline-first-edf" class="sidebar-link">earliest deadline first(EDF)</a></li><li class="sidebar-sub-header"><a href="/logs/os.html#proportional-share-scheduling" class="sidebar-link">proportional share scheduling</a></li></ul></li><li class="sidebar-sub-header"><a href="/logs/os.html#little-s-formula" class="sidebar-link">little's formula</a></li><li class="sidebar-sub-header"><a href="/logs/os.html#amdahl’s-law" class="sidebar-link">Amdahl’s Law</a></li><li class="sidebar-sub-header"><a href="/logs/os.html#thread-mapping" class="sidebar-link">thread mapping</a></li><li class="sidebar-sub-header"><a href="/logs/os.html#pthread" class="sidebar-link">pthread</a></li><li class="sidebar-sub-header"><a href="/logs/os.html#implicit-threads" class="sidebar-link">implicit threads</a></li><li class="sidebar-sub-header"><a href="/logs/os.html#thread-cancellation" class="sidebar-link">Thread cancellation</a></li><li class="sidebar-sub-header"><a href="/logs/os.html#posix-ipc" class="sidebar-link">Posix IPC</a></li><li class="sidebar-sub-header"><a href="/logs/os.html#sockets" class="sidebar-link">sockets</a></li><li class="sidebar-sub-header"><a href="/logs/os.html#critical-section-problem" class="sidebar-link">Critical section problem</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/logs/os.html#peterson-s-solution" class="sidebar-link">Peterson's solution</a></li></ul></li><li class="sidebar-sub-header"><a href="/logs/os.html#locks" class="sidebar-link">locks</a></li><li class="sidebar-sub-header"><a href="/logs/os.html#bounded-waiting-mutual-exclusion" class="sidebar-link">bounded waiting mutual exclusion</a></li><li class="sidebar-sub-header"><a href="/logs/os.html#mutex" class="sidebar-link">mutex</a></li><li class="sidebar-sub-header"><a href="/logs/os.html#semaphore" class="sidebar-link">semaphore</a></li><li class="sidebar-sub-header"><a href="/logs/os.html#deadlock" class="sidebar-link">deadlock</a></li><li class="sidebar-sub-header"><a href="/logs/os.html#starvation" class="sidebar-link">starvation</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/logs/os.html#bounded-buffer-problem" class="sidebar-link">bounded buffer problem</a></li><li class="sidebar-sub-header"><a href="/logs/os.html#reader-write-problem" class="sidebar-link">reader-write problem</a></li><li class="sidebar-sub-header"><a href="/logs/os.html#dining-philosophers-problem" class="sidebar-link">dining-philosophers problem</a></li></ul></li><li class="sidebar-sub-header"><a href="/logs/os.html#monitors" class="sidebar-link">monitors</a></li><li class="sidebar-sub-header"><a href="/logs/os.html#monitors-implementation" class="sidebar-link">monitors implementation</a></li><li class="sidebar-sub-header"><a href="/logs/os.html#condition-variables" class="sidebar-link">condition variables</a></li><li class="sidebar-sub-header"><a href="/logs/os.html#single-resource" class="sidebar-link">single resource</a></li><li class="sidebar-sub-header"><a href="/logs/os.html#sync-in-linux" class="sidebar-link">sync in linux</a></li><li class="sidebar-sub-header"><a href="/logs/os.html#distributed" class="sidebar-link">Distributed</a></li></ul></li><li><a href="/logs/papernotes.html" class="sidebar-link">paper reading notes</a></li><li><a href="/logs/pl.html" class="sidebar-link">PL</a></li><li><a href="/logs/R.html" class="sidebar-link">R</a></li><li><a href="/logs/RL.html" class="sidebar-link">Reinforcement Learning</a></li><li><a href="/logs/social.html" class="sidebar-link">Social</a></li><li><a href="/logs/vision.html" class="sidebar-link">Vision</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="os"><a href="#os" class="header-anchor">#</a> OS</h1> <h2 id="concept"><a href="#concept" class="header-anchor">#</a> concept</h2> <ul><li><p>3 main purpose:</p></li> <li><p>when to waste resource</p></li> <li><p>main difficult of writing a real-time system</p></li> <li><p>distinction between kernel mode and user mode</p></li> <li><p>following instruction should be previledged, in kernel mode</p> <ol><li><p>set value of timer</p></li> <li><p>clear memory</p></li> <li><p>turn off interrupts</p></li> <li><p>modify entries in device-status table</p></li> <li><p>access I/O device</p></li></ol></li></ul> <h2 id="ring-level"><a href="#ring-level" class="header-anchor">#</a> Ring level</h2> <p>kernel mode in ring 0, user mode in ring 3</p> <h2 id="register"><a href="#register" class="header-anchor">#</a> Register</h2> <blockquote><p>x86 GPR
EAX
EBX
ECX counter in loops
EDX
EDI destination in string/memory ops
ESI source in string/memory ops
ESP stack pointer
EBP base frame pointer
CR0 paging on/off
CR2 linear address that caused a page fault
CR3 base address of paging data structure
CR4 hardware virtualization config
DR0-7 memory breakpoints</p></blockquote> <blockquote><p>EFLAGS</p></blockquote> <p>ZF zero
SF sign
CF carry
OF overflow</p> <p>jump table</p> <blockquote><p>IDT
change with reboots</p></blockquote> <h2 id="assembly"><a href="#assembly" class="header-anchor">#</a> assembly</h2> <p>XOR reg, reg</p> <p>REP/REPNE prefix</p> <p>STOS/SCAS</p> <blockquote><p>calling conventions
CDECL
STDCALL
FASTCALL</p></blockquote> <blockquote><p>function prologue/epilogue</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>sum = addme(x,y)
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>push ebp
move ebp, esp

movsx eax, word ptr [ebp+8]
movsx ecx, word ptr [ebp+0Ch]
add eax, ecx

mov esp, ebp
pop ebp
retn
</code></pre></div><p>frame pointer omission: skip EBP</p> <blockquote><p>x64</p></blockquote> <p>RIP-relative addressing</p> <p>one calling convention</p> <h1 id="interrupt"><a href="#interrupt" class="header-anchor">#</a> Interrupt</h1> <h2 id="interrupt-vector"><a href="#interrupt-vector" class="header-anchor">#</a> Interrupt vector</h2> <ul><li><p>contains the addresses of all the service routines</p></li> <li><p>asynchronous :Triggered by an event from a “device”</p></li></ul> <h3 id="program-status-word"><a href="#program-status-word" class="header-anchor">#</a> program status word</h3> <ul><li><p>condition code bits set by comparion instructions</p></li> <li><p>CPU priority</p></li> <li><p>mode, user/kernel</p></li></ul> <h1 id="trap"><a href="#trap" class="header-anchor">#</a> trap</h1> <p>Synchronous: triggered by “trap instruction” for syscall</p> <p>Side-effect of executing a trap in userspace is that an “exception” is raised and program execution continues at a prescribed instruction in the kernel</p> <h1 id="exception"><a href="#exception" class="header-anchor">#</a> exception</h1> <p>Synchronous: triggered by a “fault condition” of an instruction condition</p> <h1 id="process"><a href="#process" class="header-anchor">#</a> Process</h1> <ul><li>process is active entity, program is passive entity</li></ul> <p>include</p> <ul><li><p>address space</p></li> <li><p>process table entries, state, registers. open files, threads state, resources.</p></li></ul> <blockquote><p>parts</p></blockquote> <ul><li><p>text section, program code</p></li> <li><p>program counter, processor registers</p></li> <li><p>stack: function parameters, return addresses, local variables</p></li> <li><p>data section, global variables</p></li> <li><p>heap: memory dynamically allocated</p></li></ul> <h2 id="address-space"><a href="#address-space" class="header-anchor">#</a> address space</h2> <ul><li><p>address virtualization</p></li> <li><p>protect private sections</p></li> <li><p>readonly, readwrite, execute</p></li></ul> <h2 id="process-control-block"><a href="#process-control-block" class="header-anchor">#</a> process control block</h2> <blockquote><p>save and load PCB when interrupt or system call</p></blockquote> <ul><li><p>process state(running, waiting)</p></li> <li><p>program counter(location of next instruction)</p></li> <li><p>CPU registers</p></li> <li><p>CPU scheduling information, priorities, scheduling queue pointers</p></li> <li><p>memory allocated</p></li> <li><p>CPU used, clock time, time limites</p></li> <li><p>IO devices, open files</p></li></ul> <h2 id="process-struct"><a href="#process-struct" class="header-anchor">#</a> process struct</h2> <div class="language- extra-class"><pre class="language-text"><code>
pid t_pid; /* process identifier */
long state; /* state of the process */
unsigned int time_slice /* scheduling information */
struct task_struct *parent; /* this process’s parent */
struct list_head children; /* this process’s children */
struct files_struct *files; /* list of open files */
struct mm_struct *mm; /* address space of this process */

</code></pre></div><h2 id="process-scheduling"><a href="#process-scheduling" class="header-anchor">#</a> process scheduling</h2> <ul><li><p>job queue, all processes</p></li> <li><p>ready queue, residing in main memory, ready to execute</p></li> <li><p>device queue, waiting for IO</p></li></ul> <blockquote><p>CPU bound, IO bound</p></blockquote> <ul><li><p>short-term scheduler(CPU scheduler), milisec, what to exec next</p></li> <li><p>long-term scheduler(job scheduler), sec, what to put to ready queue</p></li> <li><p>medium-term scheduler, remove, store, recover, control degree of multiprogramming</p></li></ul> <h2 id="context-switch"><a href="#context-switch" class="header-anchor">#</a> context switch</h2> <p>Process Control Block</p> <h2 id="process-creation"><a href="#process-creation" class="header-anchor">#</a> process creation</h2> <p>parent <code>fork()</code> children, and <code>exec()</code> children, wait till children's termination</p> <ul><li><p>sharing options, share all, share subset, share none</p></li> <li><p>execution options, execute concurrently, or parent watis until children terminate</p></li></ul> <div class="language- extra-class"><pre class="language-text"><code>
pid_t pid = fork();
if (pid == 0) {
  // child process
  execv(path, executablename);
} else if (pid &gt; 0) {
  // parent process
  waitpid(pid, &amp;status, option);
} else {
  // fork failed
}
</code></pre></div><h2 id="process-termination"><a href="#process-termination" class="header-anchor">#</a> process termination</h2> <ul><li><p>ask os to delete itself by calling <code>exit()</code></p></li> <li><p>return data from child to parent using <code>wait()</code></p></li> <li><p>parent use <code>abort()</code> to terminate child</p></li> <li><p>cascade termination, child existence is dependent on parent</p></li></ul> <blockquote><p>zombie, if no parent waiting</p></blockquote> <blockquote><p>orphan, if parent terminate without calling wait()</p></blockquote> <h2 id="param-passing"><a href="#param-passing" class="header-anchor">#</a> param passing</h2> <ul><li><p>pass to registers</p></li> <li><p>block(linux/solaris), save addresses in register</p></li> <li><p>stack, pushed by program, popped by OS</p></li></ul> <h2 id="system-call"><a href="#system-call" class="header-anchor">#</a> system call</h2> <p>system calls are an extension of ABI(Application Binary Interface)</p> <p>definition agreed upon by libc and kernel</p> <p>implemented as assembler largely taking the arguments already in the right registers and <a href="#trap">TRAP</a>-ing into the kernel</p> <p>and run a peice of assembler code:</p> <ul><li><p>check the syscall number is in range</p></li> <li><p>change stack to kernel</p></li> <li><p>arguments already in place</p></li> <li><p>call to syscall_table[registers.syscall_number]</p></li> <li><p>switch back from kernel stack to user stack and <a href="">RFI</a></p></li></ul> <p>The compiler associates the syscall number with the kernel internal function</p> <h2 id="system-call-list"><a href="#system-call-list" class="header-anchor">#</a> system call list</h2> <ul><li>file management</li></ul> <p>create file, delete file</p> <p>open, close</p> <p>read, write, reposition</p> <p>get, set file attributes</p> <ul><li>device management</li></ul> <p>request, release device</p> <p>read, write, reposition</p> <p>get, set device attributes</p> <p>attach, detach devices</p> <ul><li>info maintenance</li></ul> <p>get, set time or date</p> <p>get, set system data</p> <p>get, set process, file, device attributes</p> <ul><li>communications</li></ul> <p>crate, delete communication connection</p> <p>send, receive messages, to host name, or process name, from client to server</p> <p>create, gain access to memory regions</p> <p>transfer status info</p> <p>attach and detach remote devices</p> <ul><li>protection</li></ul> <p>control access</p> <p>get, set permissions</p> <p>allow, deny user access</p> <h2 id="system-programs"><a href="#system-programs" class="header-anchor">#</a> system programs</h2> <ul><li>file management</li></ul> <p>create, delete, copy, rename, print, dump, list</p> <ul><li>status info</li></ul> <p>data, time, memory space, disk space, number of users</p> <p>performance, logging, debugging</p> <p>format and print to terminals</p> <p>registry - store and retrive configuration info</p> <ul><li>file modification</li></ul> <p>create, modify, search content, transform text</p> <ul><li>programming-language support</li></ul> <p>compilers, assemblers, debuggers, interpreters</p> <ul><li>program loading and execution</li></ul> <p>absolute loaders, relocatable loaders, linkage editors, overlay loaders, debugging systems</p> <ul><li>comminicatiosn</li></ul> <p>create virtual connection among processes, users, computer systems.
absolute loaders</p> <ul><li>background service</li></ul> <p>launch at boot time, disk checking, process scheduling, error logging, printing</p> <p>subsystems, daemons</p> <h2 id="process-states"><a href="#process-states" class="header-anchor">#</a> process states</h2> <p>new, running, waiting, ready, terminated</p> <hr> <h1 id="process-scheduling-2"><a href="#process-scheduling-2" class="header-anchor">#</a> process scheduling</h1> <h2 id="short-term-scheduler"><a href="#short-term-scheduler" class="header-anchor">#</a> short-term scheduler</h2> <ul><li><p>ready</p></li> <li><p>running</p></li> <li><p>waiting</p></li> <li><p>terminate</p></li></ul> <blockquote><p>running to wait, terminate are non-preemptive, all others are preemptive, caused by access to shared data, preemption in kernel mode, interrupt during crucial os activities.</p></blockquote> <h2 id="dispatcher"><a href="#dispatcher" class="header-anchor">#</a> dispatcher</h2> <p>give control of CPU to the process selected by scheduler</p> <ul><li><p>context switch</p></li> <li><p>switch to user mode</p></li> <li><p>jmp to the location</p></li></ul> <blockquote><p>dispatch lantency: $t_{start new proc} - t_{stop one proc}$
= confict phase(real-time CPU scheduling) + dispatch phase</p></blockquote> <h3 id="conflict-phase"><a href="#conflict-phase" class="header-anchor">#</a> conflict phase</h3> <ul><li><p>preempt process running in kernel mode</p></li> <li><p>release resources needed by high prio processes</p></li></ul> <h2 id="scheduler-metric"><a href="#scheduler-metric" class="header-anchor">#</a> scheduler metric</h2> <ul><li><p>CPU utilization</p></li> <li><p>throughtput</p></li> <li><p>turnaround time, amount of time to execute a particular process</p></li> <li><p>waiting time</p></li> <li><p>response time</p></li></ul> <h3 id="convoy-effect"><a href="#convoy-effect" class="header-anchor">#</a> convoy effect</h3> <p>short process behind long process</p> <h2 id="priority-scheduling"><a href="#priority-scheduling" class="header-anchor">#</a> priority scheduling</h2> <p>use aging(increase prio as time progresses) to solve starvation(low prio never get served)</p> <h2 id="round-robin-with-quantum"><a href="#round-robin-with-quantum" class="header-anchor">#</a> round robin with quantum</h2> <p>80% of CPU bursts should be shorter than q</p> <h2 id="multilevel-queue"><a href="#multilevel-queue" class="header-anchor">#</a> multilevel queue</h2> <p>scheduling between queues</p> <ul><li><p>fixed prio, serve all from foreground and then background</p></li> <li><p>time slice, 80% to fg, 20% to bg</p></li></ul> <p>implement aging, move between queues</p> <h2 id="thread-scheduling"><a href="#thread-scheduling" class="header-anchor">#</a> thread scheduling</h2> <p>process-contention scope</p> <p>system-contention scope</p> <p>linux macos only allow pthread_scope_system</p> <h2 id="multi-processor-scheudling"><a href="#multi-processor-scheudling" class="header-anchor">#</a> multi processor scheudling</h2> <ul><li><p>homogeneous</p></li> <li><p>asymmetric, only one processor access the data structures</p></li> <li><p>symmetric(SMP), most common; each has self-sheduling, ready queue in common, or each has its own</p></li></ul> <blockquote><p>processor affinity, due to memory locality, process are close to certain processor.</p></blockquote> <blockquote><p>might need move process across processors, either</p></blockquote> <ul><li>push, periodic task check load on processors, and move task across CPUs</li> <li>pull, idle processors pulls waiting task fro busy one</li></ul> <h2 id="real-time-scheduling"><a href="#real-time-scheduling" class="header-anchor">#</a> real time scheduling</h2> <ul><li><p>soft real time</p></li> <li><p>hard real time</p></li></ul> <h3 id="rate-montonic-scheduling"><a href="#rate-montonic-scheduling" class="header-anchor">#</a> Rate Montonic Scheduling</h3> <p>prio assigned based on inverse of period</p> <h3 id="earliest-deadline-first-edf"><a href="#earliest-deadline-first-edf" class="header-anchor">#</a> earliest deadline first(EDF)</h3> <p>prio assigned based on deadline</p> <h3 id="proportional-share-scheduling"><a href="#proportional-share-scheduling" class="header-anchor">#</a> proportional share scheduling</h3> <h2 id="little-s-formula"><a href="#little-s-formula" class="header-anchor">#</a> little's formula</h2> <p>in steady state, processes leaving queue must equal processes arriving</p> <p>$$ n = \lambda \mathbf W $$</p> <p>n: average queue length</p> <p>W: average waiting time in queue</p> <p>$\lambda$: average arrival rate into queue</p> <h1 id="thread"><a href="#thread" class="header-anchor">#</a> Thread</h1> <ul><li><p>processes are resource containers</p></li> <li><p>threads are unit of execution in a process</p></li> <li><p>threads share code, data, files</p></li> <li><p>threads has own registers, stacks</p></li></ul> <h2 id="amdahl’s-law"><a href="#amdahl’s-law" class="header-anchor">#</a> Amdahl’s Law</h2> <p>$$ speedup \leq \frac{1}{S + \frac{1-S}{N}} $$</p> <p>S: serial portion (parallel or serial)</p> <p>N: processing cores</p> <p>N goes to infinite, speedup approaches to $\frac{1}{S}$</p> <h2 id="thread-mapping"><a href="#thread-mapping" class="header-anchor">#</a> thread mapping</h2> <ul><li><p>many to one</p></li> <li><p>one to one</p> <ul><li>linux, window, solaris</li></ul></li> <li><p>many to many</p> <ul><li>windows ThreadFiber</li></ul></li></ul> <h2 id="pthread"><a href="#pthread" class="header-anchor">#</a> pthread</h2> <ul><li><p>either user or kernel level</p></li> <li><p>POSIX standard IEEE 1003.1c</p></li> <li><p>include &lt;pthread.h&gt;</p> <ul><li><code>void *runner(void *param)</code></li> <li><code>pthread_t tid;</code></li> <li><code>pthread_attr_t attr;</code></li> <li><code>pthread_exit(0);</code></li></ul></li> <li><p>thread local storage</p></li></ul> <h2 id="implicit-threads"><a href="#implicit-threads" class="header-anchor">#</a> implicit threads</h2> <ul><li><p>thread pools</p> <ul><li>create new is slow</li> <li>size bounded</li> <li>seperation of tasks</li></ul></li> <li><p>OpenMP</p> <ul><li><code>#pragma omp parallel for</code></li></ul></li> <li><p>GCD</p> <ul><li>block <code>^{}</code></li> <li>serial(main queue) and concurrent(priority low, default, high)</li> <li><code>dispatch_queue_t queue = dispatch_get_global_queue(prio_default, 0);</code></li> <li><code>dispatch_async(queue, ^{});</code></li></ul></li></ul> <h2 id="thread-cancellation"><a href="#thread-cancellation" class="header-anchor">#</a> Thread cancellation</h2> <ul><li><p>async cancel, terminate immediately</p></li> <li><p>deferred cancel, allow thread periodically check if itself should be cancelled</p></li> <li><p>cancel state either disabled or enabled, cancel default mode is deferred</p></li> <li><p>cancellation is a signal</p></li> <li><p><code>pthread_testcancel()</code></p></li> <li><p>cleanup handler</p></li></ul> <div class="language- extra-class"><pre class="language-text"><code>pthread_t tid;

pthread_create(&amp;tid, 0, worker, NULL);

pthread_cancel(tid);
</code></pre></div><h1 id="ipc"><a href="#ipc" class="header-anchor">#</a> IPC</h1> <ul><li><p>shared memory</p></li> <li><p>message passing</p></li></ul> <h2 id="posix-ipc"><a href="#posix-ipc" class="header-anchor">#</a> Posix IPC</h2> <ol><li>create shared memory segment</li></ol> <div class="language- extra-class"><pre class="language-text"><code>char * name = &quot;this class sucks&quot;;
int shm_fd = shm_open(name, O_CREAT | O_RDWR, 0666);
</code></pre></div><ol start="2"><li><p>open an existing memory segment to share it</p></li> <li><p>set the size of object</p></li></ol> <div class="language- extra-class"><pre class="language-text"><code>ftruncate(shm fd, 4096)
</code></pre></div><ol start="4"><li>map into address space(find free unused area)</li></ol> <div class="language- extra-class"><pre class="language-text"><code>char * shared_addr = mmap(NULL, 4096, PROT_READ | PROT_WRITE, MAP_SHARED, shm_fd, 0);
</code></pre></div><ol start="5"><li>process write to the shared memory</li></ol> <div class="language- extra-class"><pre class="language-text"><code>sprintf(shared_addr, &quot;writing to the shared memory&quot;);
</code></pre></div><h2 id="sockets"><a href="#sockets" class="header-anchor">#</a> sockets</h2> <ul><li><p>Special IP address 127.0.0.1 (loopback) to refer to system on which process is running</p></li> <li><p>tcp socket, udp socket, multicast socket in Java</p></li></ul> <h1 id="rpc"><a href="#rpc" class="header-anchor">#</a> RPC</h1> <ul><li><p>stubs</p></li> <li><p>marshalls</p></li> <li><p>RPCGen</p></li> <li><p>matchmaker</p></li></ul> <h1 id="pipes"><a href="#pipes" class="header-anchor">#</a> pipes</h1> <ul><li><p>ordinary pipes
only access to parent-child relationship, unidirectional</p></li> <li><p>named pipes
all access, bidirectional, used for several processes</p></li></ul> <p>provide buffer, block, unblock producers and consumers</p> <p>4kb guaranteed to be atomic</p> <p>64kb</p> <p>scheduling, blocking, resource management.</p> <h1 id="process-syncronization"><a href="#process-syncronization" class="header-anchor">#</a> process syncronization</h1> <h2 id="critical-section-problem"><a href="#critical-section-problem" class="header-anchor">#</a> Critical section problem</h2> <div class="language- extra-class"><pre class="language-text"><code>do {
  entry section

    critical section

  exit sectionm

  remainder section

} while(true)

</code></pre></div><ol><li><p>mutual exclusion</p></li> <li><p>progress</p></li> <li><p>bounded waiting</p></li></ol> <h3 id="peterson-s-solution"><a href="#peterson-s-solution" class="header-anchor">#</a> Peterson's solution</h3> <p>load and store are atomic</p> <p>turn indicates whose turn</p> <p>flag indicates if ready to enter critical section</p> <div class="language- extra-class"><pre class="language-text"><code>do {
  flag[i] = true;
  turn = j;
  while (flag[j] &amp;&amp; turn == j);

    critical section

  flag[i] = false;

    remainder section

} while (true);
</code></pre></div><h2 id="locks"><a href="#locks" class="header-anchor">#</a> locks</h2> <ul><li>test and set</li></ul> <div class="language- extra-class"><pre class="language-text"><code>function test_and_set(boolean * target) {
  boolean rv = *target;
  target = true;
  return rv;
}

do {
  while (test_and_set(&amp;block));
    critical section
  lock = false;
    remainder section
} while(true);

</code></pre></div><ul><li>compare and swap</li></ul> <div class="language- extra-class"><pre class="language-text"><code>int compare_and_swap(int *value, int expected, int new_value) {
  int temp = *value;
  if (*value == expected)
    *value = new_value;
  return temp;
}

do {
  while(compare_and_swap(&amp;lock, 0, 1) != 0);
    critical section
  lock = 0;
    remainder section
} while(true);

</code></pre></div><h2 id="bounded-waiting-mutual-exclusion"><a href="#bounded-waiting-mutual-exclusion" class="header-anchor">#</a> bounded waiting mutual exclusion</h2> <div class="language- extra-class"><pre class="language-text"><code>do {
  waiting[i] = true;
  key = true;
  while (waiting[i] &amp;&amp; key)
    key = test_and_set(&amp;lock);

  waiting[i] = false;
    /* critical section */
  j = (i + 1) % n;
  while ((j != i) &amp;&amp; !waiting[j])
    j = (j + 1) % n;

  if (j == i)
    lock = false;
  else
    waiting[j] = false;
     /* remainder section */
} while (true);
</code></pre></div><h2 id="mutex"><a href="#mutex" class="header-anchor">#</a> mutex</h2> <ul><li><p>acquire</p></li> <li><p>release</p></li> <li><p>both must be atomic</p></li> <li><p>require busy waiting</p></li> <li><p>thus call a spinlock</p></li></ul> <div class="language- extra-class"><pre class="language-text"><code>acquire() {
  while (!available);
    /* busy wait */
  available = false;
}
release() {
  available = true;
}

</code></pre></div><h2 id="semaphore"><a href="#semaphore" class="header-anchor">#</a> semaphore</h2> <ul><li><p>wait, P()</p></li> <li><p>signal, V()</p></li></ul> <div class="language- extra-class"><pre class="language-text"><code>wait(S) {
  while (S &lt;= 0);
  // busy wait
  S--;
}

signal(S) {
  S++;
}

</code></pre></div><ul><li><p>counting semaphore</p></li> <li><p>binary semaphore</p></li></ul> <blockquote><blockquote><p><strong>implementation with busy waiting</strong></p></blockquote></blockquote> <ul><li><p>must guarantee no processes run wait or signal of one semaphore at the same time</p></li> <li><p>thus must be put in critical section, and we have busy waiting</p></li> <li><p>implementation code is short, so chance of busy waiting is rare.</p></li></ul> <blockquote><blockquote><p><strong>implementation without busy waiting</strong></p></blockquote></blockquote> <div class="language- extra-class"><pre class="language-text"><code>typedef struct {
  int value;
  struct process *list;
} semaphore;
</code></pre></div><ul><li>block</li></ul> <p>place the process on the waiting queue</p> <ul><li>wakeup</li></ul> <p>remove the process from the waiting queue, add to ready queue</p> <h2 id="deadlock"><a href="#deadlock" class="header-anchor">#</a> deadlock</h2> <p>two or more processes are waiting indefinitely for an event that can be caused by only one of the waiting processes</p> <table><thead><tr><th>P_0</th> <th>P_1</th></tr></thead> <tbody><tr><td>wait(S);</td> <td>wait(Q);</td></tr> <tr><td>wait(Q);</td> <td>wait(S);</td></tr> <tr><td>...</td> <td>...</td></tr> <tr><td>signal(S);</td> <td>signal(Q);</td></tr> <tr><td>signal(Q);</td> <td>signal(S);</td></tr></tbody></table> <h2 id="starvation"><a href="#starvation" class="header-anchor">#</a> starvation</h2> <p>A process may never be removed from the semaphore queue in which it is
suspended</p> <h3 id="bounded-buffer-problem"><a href="#bounded-buffer-problem" class="header-anchor">#</a> bounded buffer problem</h3> <p>n buffers</p> <ul><li><p>semaphore mutex = 1</p></li> <li><p>semaphore full = 0</p></li> <li><p>semaphore empty = n</p></li></ul> <blockquote><blockquote><p>producer</p></blockquote></blockquote> <div class="language- extra-class"><pre class="language-text"><code>do {
  // produce an item;
  wait(empty);
  wait(mutex);

  ...
  // add next produced to the buffer
  ...

  signal(mutex);
  signal(full);
} while(true);
</code></pre></div><blockquote><blockquote><p>consumer</p></blockquote></blockquote> <div class="language- extra-class"><pre class="language-text"><code>do {
  wait(full);
  wait(mutex);

  ...
  // remove an item from buffer

  signal(mutex);
  signal(empty);

  // consumer the item
} while(true);
</code></pre></div><h3 id="reader-write-problem"><a href="#reader-write-problem" class="header-anchor">#</a> reader-write problem</h3> <p>if a writer is in the critical section and n readers are waiting, then one reader is queued on rw mutex, and n − 1 readers are queued on mutex</p> <ul><li>semaphore rw mutex = 1</li> <li>semaphore mutex = 1</li> <li>int read count = 0</li></ul> <blockquote><blockquote><p>writer</p></blockquote></blockquote> <div class="language- extra-class"><pre class="language-text"><code>do {
  wait(rw mutex);
  ...
  /* writing is performed */
  ...
  signal(rw mutex);
} while (true);
</code></pre></div><blockquote><blockquote><p>producer</p></blockquote></blockquote> <div class="language- extra-class"><pre class="language-text"><code>do {
  wait(mutex);
  read count++;

  if (read count == 1)
    wait(rw mutex);

  signal(mutex);
    ...
    /* reading is performed */
    ...
  wait(mutex);
  read count--;

  if (read count == 0)
    signal(rw mutex);

  signal(mutex);
} while (true);
</code></pre></div><h3 id="dining-philosophers-problem"><a href="#dining-philosophers-problem" class="header-anchor">#</a> dining-philosophers problem</h3> <p>five chair, five single chopsticks</p> <p>when think, does not interact with others, when hungry, pick two around him or her.</p> <p>allocate several resources among several processes in a deadlock-free and starvation-free manner</p> <blockquote><blockquote><p>soluttion with deadlock</p></blockquote></blockquote> <div class="language- extra-class"><pre class="language-text"><code>do {
  wait(chopstick[i]);
  wait(chopstick[(i+1) % 5]);
    ...
    /* eat for awhile */
    ...
  signal(chopstick[i]);
  signal(chopstick[(i+1) % 5]);
    ...
    /* think for awhile */
    ...
} while (true);
</code></pre></div><blockquote><blockquote><p>solution with <a href="#monitors">monitors</a> and <a href="#conditional-variables">conditional variables</a></p></blockquote></blockquote> <div class="language- extra-class"><pre class="language-text"><code>monitor philosopher-dining-problem {
  enum {THINKING, HUNGRY, EATING} state[5];
  condition self[5];

  void pickup(int i) {
    state[i] = HUNGRY;
    test[i];
    if (state[i] != EATING) {
      self[i].wait();
    }
  }

  void putdown(int i) {
    state[i] = THINKING;
    test[i + 1];
    test[(i + 4) % 5];
  }

  void test(int i) {
    if (state[(i+1)%5] != EATING &amp;&amp; state[(i+4)%5] != EATING &amp;&amp; state[i] == HUNGRY) {
      state[i] = EATING;
      self[i].signal();
    }
  }

  initialization_code() {
    for(int i = 0; i &lt; 5; i++) {
      state[i] = THINKING;
    }
  }

}

DiningPhilosophers.pickup(i);

... eat ...

DiningPhilosophers.putdown(i);

</code></pre></div><h2 id="monitors"><a href="#monitors" class="header-anchor">#</a> monitors</h2> <ul><li><p>high-level abstraction</p></li> <li><p>internal vars only accessible by the code within the procedure</p></li> <li><p>only one process may be active within the monitor at a time</p></li></ul> <div class="language- extra-class"><pre class="language-text"><code>monitor name {
  procedure 1 {};
  procedure 2 {};
  initialize() {};
}
</code></pre></div><h2 id="monitors-implementation"><a href="#monitors-implementation" class="header-anchor">#</a> monitors implementation</h2> <p>The signaling processes can use <code>next</code> to suspend themselves.
An integer variable <code>next_count</code> is also provided to count the number of processes suspended on <code>next</code></p> <blockquote><p>external function F</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>wait(mutex);
  ...
  body of F
  ...
if (next_count &gt; 0)
  signal(next);
else
  signal(mutex);
</code></pre></div><blockquote><p>x.wait()
x_count, x_sem both init to 0</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>x_count++;

if (next_count &gt; 0)
  signal(next);
else
  signal(mutex);

wait(x_sem);
x_count--;

</code></pre></div><blockquote><p>x.signal()</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>if (x_count &gt; 0) {
  next_count++;
  signal(x_sem);
  wait(next); // signal and wait
  next_count--;
}
</code></pre></div><h2 id="condition-variables"><a href="#condition-variables" class="header-anchor">#</a> condition variables</h2> <p>wait and signal between two processes</p> <ul><li><p>x.wait()</p> <ul><li>the process invoking this operation is suspended until another process invokes signal</li></ul></li> <li><p>x.signal()</p> <ul><li>resume one of the processes that invoked x.wait()</li> <li>if no x.wait(), no effect on the variable.</li></ul></li></ul> <p>The x.signal() operation resumes exactly one suspended process.</p> <p>If no process is suspended, then the signal() operation has no effect</p> <blockquote><blockquote><p>x.wait in Q, x.signal in P, P and Q cannot continue simultaneously, thus two options:</p></blockquote></blockquote> <ul><li><p>P signal and P wait, until Q leaves the monitor, or for another condition</p></li> <li><p>P signal and P continue, Q wait until P leaves the monitor, or Q wait for another condition</p></li></ul> <h2 id="single-resource"><a href="#single-resource" class="header-anchor">#</a> single resource</h2> <div class="language- extra-class"><pre class="language-text"><code>monitor ResourceAllocator
{
  boolean busy;
  condition x;
  void acquire(int time) {
    if (busy)
      x.wait(time);
    busy = TRUE;
  }
  void release() {
    busy = FALSE;
    x.signal();
  }

  initialization code() {
    busy = FALSE;
  }
}
</code></pre></div><h2 id="sync-in-linux"><a href="#sync-in-linux" class="header-anchor">#</a> sync in linux</h2> <blockquote><p>Prior to kernel Version 2.6, disables interrupts to implement short critical sections</p></blockquote> <blockquote><p>On single-cpu system, spinlocks replaced by enabling and disabling kernel preemption</p></blockquote> <h2 id="distributed"><a href="#distributed" class="header-anchor">#</a> Distributed</h2> <p>itrusion detection system
mimicking virtual machine
mariadb for transaction
postgre for spatial</p> <p>plotly</p> <p>coreos
ggn fleet etcd
go-nerve health-check
go-synapse</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/josherich/blog/edit/master/logs/os.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/logs/ops.html" class="prev">Ops</a></span> <span class="next"><a href="/logs/papernotes.html">paper reading notes</a>
      →
    </span></p></div> </main></div><div class="global-ui"><SWUpdatePopup></SWUpdatePopup><!----></div></div>
    <script src="/logs/assets/js/app.09a71387.js" defer></script><script src="/logs/assets/js/2.5fba0fc3.js" defer></script><script src="/logs/assets/js/24.a688e03c.js" defer></script>
  </body>
</html>
